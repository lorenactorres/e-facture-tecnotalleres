<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Action -->
        <record model="ir.actions.act_window" id="action_hr_payroll_flat_file">
            <field name="name">Archivo plano de pago de nómina</field>
            <field name="res_model">hr.payroll.flat.file</field>
            <field name="view_mode">tree,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Crear nuevo archivo de pago
                </p>
            </field>
        </record>

        <!-- Tree View -->
        <record model="ir.ui.view" id="view_hr_payroll_flat_file_tree">
            <field name="name">hr.payroll.flat.file.tree</field>
            <field name="model">hr.payroll.flat.file</field>
            <field name="arch" type="xml">
                <tree decoration-danger="error_count > 0" decoration-warning="warning_count > 0">
                    <field name="name"/>
                    <field name="payment_type"/>
                    <field name="type"/>
                    <field name="source_information"/>
                    <field name="payslip_run_ids" widget="many2many_tags"/>
                    <!-- <field name="payslip_ids" widget="many2many_tags"/> -->
                    <field name="transmission_date"/>
                    <field name="application_date"/>
                    <field name="total_amount" sum="Total"/>
                    <field name="total_employees"/>
                    <field name="error_count"/>
                    <field name="warning_count"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <!-- Form View -->
        <record id="view_hr_payroll_flat_file_form" model="ir.ui.view">
            <field name="name">hr.payroll.flat.file.form</field>
            <field name="model">hr.payroll.flat.file</field>
            <field name="arch" type="xml">
            <form>
                <header>
                    <button name="generate_flat_file" string="Generar" type="object" class="btn btn-primary" invisible="state != 'draft'"/>
                    <button name="action_process" string="Procesar" type="object" class="btn btn-primary" invisible="state != 'generated'"/>
                    <button name="action_draft" string="Volver a Borrador" type="object" invisible="state not in ('generated','cancelled')"/>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" icon="fa-warning" invisible="error_count == 0">
                            <field name="error_count" widget="statinfo" string="Errores"/>
                        </button>
                        <button class="oe_stat_button" icon="fa-exclamation" invisible="warning_count == 0">
                            <field name="warning_count" widget="statinfo" string="Advertencias"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                    </div>
                    <group>
                        <group>
                            <field name="payment_type" readonly="state != 'draft'"/>
                            <field name="type" widget="radio" readonly="state != 'draft'"/>
                            <field name="source_information" widget="radio" readonly="state != 'draft'"/>
                            <field name="company_id" readonly="state != 'draft'"/>
                            <field name="journal_id" invisible="type != 'GL'" required="type == 'GL'" readonly="state != 'draft'"/>
                        </group>
                        <group>
                            <field name="transmission_date"/>
                            <field name="application_date"/>
                            <field name="description"/>
                            <field name="vat_payer" readonly="1"/>
                            <field name="date_start" required="source_information == 'rango'"/>
                            <field name="date_end" required="source_information == 'rango'"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Configuración" invisible="state != 'draft'">
                            <group>
                                <group>
                                    <field name="payslip_run_ids" widget="many2many_tags" invisible="source_information != 'lote'" required="source_information == 'lote'" domain="[('state','=','close')]"/>
                                    <field name="payslip_ids" widget="many2many_tags" invisible="source_information != 'liquidacion'" required="source_information == 'liquidacion'" domain="[('state','=','done')]"/>
                                    <field name="flat_rule_not_included"/>
                                    <field name="exclude_loan"/>
                                    <field name="exclude_concepts_ids" widget="many2many_tags"/>
                                </group>
                                <group>
                                    <field name="notes"/>
                                </group>
                            </group>
                        </page>
                        <page string="Archivos Generados" invisible="state == 'draft'">
                            <field name="detail_ids">
                                <tree>
                                    <field name="journal_id"/>
                                    <field name="plane_type"/>
                                    <field name="amount_total" sum="Total"/>
                                    <field name="amount_excluded" sum="Total Excluido"/>
                                    <field name="employee_count"/>
                                    <field name="payslip_count"/>
                                    <field name="payment_status" widget="badge"/>
                                    <field name="current_balance" widget="monetary"/>
                                    <field name="projected_balance" widget="monetary" decoration-danger="projected_balance &lt; 0" decoration-warning="projected_balance &lt; 1000000"/>
                                    <field name="state"/>
                                    <field name="generation_date"/>
                                    <field name="txt_file" column_invisible="1"/>
                                    <field name="excel_file" column_invisible="1"/>
                                    <field name="unpaid_payslip_ids" column_invisible="1"/>
                                    <button name="download_txt" string="TXT" type="object" icon="fa-download" invisible="not txt_file"/>
                                    <button name="download_excel" string="Excel" type="object" icon="fa-file-excel-o" invisible="not excel_file"/>
                                    <button name="action_mark_payslip_unpaid" string="Error" type="object" class="btn-secondary" icon="fa-times-circle text-danger" invisible="state == 'draft'"/>
                                    <button name="action_resolve_transfer" string="FIX" type="object" class="btn-primary" icon="fa-check-circle text-success" invisible="not unpaid_payslip_ids"/>
                                </tree>
                                <form>
                                    <header>
                                        <button name="action_regenerate" string="Regenerar Archivo" type="object" class="btn-secondary" invisible="state != 'draft'"/>
                                        <button name="action_mark_payslip_unpaid" string="Marcar Como No Pagada" type="object" class="btn-secondary"  invisible="state == 'draft'"/>
                                        <button name="action_resolve_transfer" string="Resolver Transferencia" type="object" class="btn-primary"
                                                invisible="not unpaid_payslip_ids"/>
                                        <field name="state" widget="statusbar"/>
                                        <field name="payment_status" widget="statusbar" statusbar_visible="draft,paid,partial,unpaid"/>
                                    </header>
                                    <sheet>
                                        <div class="oe_button_box" name="button_box">
                                            <button name="download_txt" type="object" class="oe_stat_button" icon="fa-file-text" invisible="not txt_file">
                                                <div class="o_field_widget o_stat_info">
                                                    <span class="o_stat_text text-success">Descargar TXT</span>
                                                </div>
                                            </button>
                                            <button name="download_excel" type="object" class="oe_stat_button" icon="fa-file-excel" invisible="not excel_file">
                                                <div class="o_field_widget o_stat_info">
                                                    <span class="o_stat_text text-success">Descargar Excel</span>
                                                </div>
                                            </button>
                                        </div>

                                        <div class="row mb-4">
                                            <div class="col-6">
                                                <div class="oe_title w-100">
                                                    <div class="o_field_highlight">
                                                        <label for="journal_id" class="text-muted"/>
                                                        <h1><field name="journal_id" readonly="1"/></h1>
                                                    </div>
                                                    <div class="o_field_highlight mt-3">
                                                        <label for="plane_type" class="text-muted"/>
                                                        <h3><field name="plane_type"/></h3>
                                                    </div>
                                                    <div class="o_field_highlight mt-3">
                                                        <label for="generation_date" class="text-muted"/>
                                                        <h4><field name="generation_date"/></h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="h-100 d-flex flex-column justify-content-center">
                                                    <div class="row text-center">
                                                        <div class="col-6">
                                                            <div class="o_stat_info">
                                                                <span class="o_stat_value"><field name="employee_count"/></span>
                                                                <span class="o_stat_text">Empleados</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="o_stat_info">
                                                                <span class="o_stat_value"><field name="payslip_count"/></span>
                                                                <span class="o_stat_text">Nóminas</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row text-center mt-4">
                                                        <div class="col-6">
                                                            <div class="o_stat_info">
                                                                <span class="o_stat_value text-success">
                                                                    <field name="amount_total" widget="monetary"/>
                                                                </span>
                                                                <span class="o_stat_text">Total a Pagar</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="o_stat_info">
                                                                <span class="o_stat_value text-warning">
                                                                    <field name="amount_excluded" widget="monetary"/>
                                                                </span>
                                                                <span class="o_stat_text">Total Excluido</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row text-center mt-4">
                                                        <div class="col-6">
                                                            <div class="o_stat_info">
                                                                <span class="o_stat_value">
                                                                    <field name="current_balance" widget="monetary"/>
                                                                </span>
                                                                <span class="o_stat_text">Saldo Actual</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="o_stat_info">
                                                                <span class="o_stat_value">
                                                                    <field name="projected_balance" widget="monetary"/>
                                                                </span>
                                                                <span class="o_stat_text">Saldo Proyectado</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <notebook class="mt-4">
                                            <page string="Liquidaciones Incluidas" name="payslips">
                                                <field name="liquidations_ids" readonly="1">
                                                    <tree decoration-info="state == 'draft'" 
                                                          decoration-success="state == 'done'" 
                                                          decoration-warning="state == 'verify'"
                                                          decoration-danger="id in parent.unpaid_payslip_ids">
                                                        <field name="employee_id"/>
                                                        <field name="number"/>
                                                        <field name="date_from"/>
                                                        <field name="date_to"/>
                                                        <field name="net_wage" sum="Total" decoration-bf="1"/>
                                                        <field name="state" widget="badge"/>
                                                        <field name="transfer_state" widget="badge"/>
                                                        <field name="transfer_date"/>
                                                    </tree>
                                                </field>
                                            </page>
                                            <page string="Información Bancaria" name="bank_info">
                                                <field name="dispersion_account_info" nolabel="1"/>
                                            </page>
                                            <page string="Nóminas No Pagadas" name="unpaid_payslips" invisible="not unpaid_payslip_ids">
                                                <field name="unpaid_payslip_ids" readonly="1">
                                                    <tree>
                                                        <field name="employee_id"/>
                                                        <field name="number"/>
                                                        <field name="date_from"/>
                                                        <field name="date_to"/>
                                                        <field name="transfer_state" widget="badge"/>
                                                        <field name="transfer_reason"/>
                                                        <field name="transfer_date"/>
                                                        <field name="transfer_notes"/>
                                                        <field name="net_wage" sum="Total"/>
                                                    </tree>
                                                </field>
                                            </page>
                                            <page string="Información Adicional" name="info">
                                                <group>
                                                    <group string="Archivos">
                                                        <field name="txt_file" filename="txt_file_name"/>
                                                        <field name="txt_file_name"/>
                                                        <field name="excel_file" filename="excel_file_name"/>
                                                        <field name="excel_file_name"/>
                                                    </group>
                                                    <group string="Notas">
                                                        <field name="notes" nolabel="1" placeholder="Ingrese notas adicionales aquí..."/>
                                                    </group>
                                                </group>
                                            </page>
                                        </notebook>
                                    </sheet>
                                    <div class="oe_chatter">
                                        <field name="message_follower_ids" groups="base.group_user"/>
                                        <field name="activity_ids"/>
                                        <field name="message_ids"/>
                                    </div>
                                </form>
                            </field>
                        </page>
                        <page string="Log de Errores" invisible="error_count + warning_count == 0">
                            <field name="log_ids" readonly="1">
                                <tree>
                                    <field name="create_date"/>
                                    <field name="type"/>
                                    <field name="error_type"/>
                                    <field name="employee_id"/>
                                    <field name="payslip_id"/>
                                    <field name="payslip_number"/>
                                    <field name="bank_id"/>
                                    <field name="account_number"/>
                                    <field name="name"/>
                                    <field name="detail"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
            </field>
        </record>

        <!-- Search View -->
        <record id="view_hr_payroll_flat_file_search" model="ir.ui.view">
            <field name="name">hr.payroll.flat.file.search</field>
            <field name="model">hr.payroll.flat.file</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name"/>
                    <field name="description"/>
                    <field name="journal_id"/>
                    <field name="payslip_run_ids"/>
                    <field name="payslip_ids"/>
                    <field name="type"/>
                    <field name="source_information"/>
                    <separator/>
                    <filter string="Con Errores" name="with_errors" domain="[('error_count', '>', 0)]"/>
                    <filter string="Con Advertencias" name="with_warnings" domain="[('warning_count', '>', 0)]"/>
                    <separator/>
                    <filter string="Borrador" name="draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Generado" name="generated" domain="[('state', '=', 'generated')]"/>
                    <filter string="Procesado" name="processed" domain="[('state', '=', 'processed')]"/>
                    <filter string="Cancelado" name="cancelled" domain="[('state', '=', 'cancelled')]"/>
                    <group expand="0" string="Agrupar Por">
                        <filter string="Tipo de Pago" name="group_payment_type" context="{'group_by': 'payment_type'}"/>
                        <filter string="Tipo Dispersión" name="group_type" context="{'group_by': 'type'}"/>
                        <filter string="Estado" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="Diario" name="group_journal" context="{'group_by': 'journal_id'}"/>
                        <filter string="Compañía" name="group_company" context="{'group_by': 'company_id'}"/>
                        <filter string="Mes" name="group_month" context="{'group_by': 'transmission_date:month'}"/>
                    </group>
                </search>
            </field>
        </record>
    
        <record id="view_hr_payroll_unpaid_wizard_form" model="ir.ui.view">
            <field name="name">hr.payroll.unpaid.wizard.form</field>
            <field name="model">hr.payroll.unpaid.wizard</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <group>
                                <field name="detail_id" invisible="1"/>
                                <field name="filter_employee" placeholder="Buscar por nombre o identificación..."/>
                            </group>
                        </group>
                        <group>
                            <field name="all_payslip_ids" readonly="1" nolabel="1" invisible="1">
                                <tree create="0" delete="0">
                                    <field name="number"/>
                                    <field name="employee_id"/>
                                    <field name="date_from"/>
                                    <field name="date_to"/>
                                    <field name="net_wage"/>
                                </tree>
                            </field>
                        </group>
                        <group>
                            <group>
                                <field name="payslip_ids" 
                                    widget="many2many_tags" 
                                    options="{'no_create': True, 'no_edit': True}"/>
                                <field name="reason"/>
                                <field name="notes" placeholder="Ingrese notas adicionales..."/>
                            </group>
                        </group>
                    </sheet>
                    <footer>
                        <button name="action_confirm" 
                                string="Confirmar" 
                                type="object" 
                                class="btn-primary"/>
                        <button string="Cancelar" 
                                class="btn-secondary" 
                                special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

    
        <record id="view_hr_payroll_resolve_transfer_wizard_form" model="ir.ui.view">
            <field name="name">hr.payroll.resolve.transfer.wizard.form</field>
            <field name="model">hr.payroll.resolve.transfer.wizard</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <group>
                                <field name="detail_id" invisible="1"/>
                                <field name="payslip_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            </group>
                            <group>
                                <field name="resolution_notes" placeholder="Ingrese notas de resolución..."/>
                            </group>
                        </group>
                    </sheet>
                    <footer>
                        <button name="action_confirm" string="Confirmar" type="object" class="btn-primary"/>
                        <button string="Cancelar" class="btn-secondary" special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <!-- Acciones de ventana -->
        <record id="action_hr_payroll_unpaid_wizard" model="ir.actions.act_window">
            <field name="name">Marcar Nóminas como No Pagadas</field>
            <field name="res_model">hr.payroll.unpaid.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="binding_model_id" ref="model_hr_payroll_flat_file_detail"/>
        </record>

        <record id="action_hr_payroll_resolve_transfer_wizard" model="ir.actions.act_window">
            <field name="name">Resolver Problemas de Transferencia</field>
            <field name="res_model">hr.payroll.resolve.transfer.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="binding_model_id" ref="model_hr_payroll_flat_file_detail"/>
        </record>

    </data>
</odoo>
      